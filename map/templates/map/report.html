{% extends 'map/base.html' %}

{% load static %}
{% load crispy_forms_tags %}

{% block extrahead %}
{% load leaflet_tags %}
   {% leaflet_js plugins="forms" %}
   {% leaflet_css plugins="forms" %}
   <link rel="stylesheet" type="text/css" href="{% static 'css/report.css' %}" />
      <script type="text/javascript">
{% comment %}

       var style = {
        "clickable": true,
        "color": "#00D",
        "fillColor": "#00D",
        "weight": 1.0,
        "opacity": 0.3,
        "fillOpacity": 0.2
    };
    var hoverStyle = {
        "fillOpacity": 0.5
    };

    var geojsonURL = 'http://localhost:8000/data/{z}/{x}/{y}.geojson';

    var geojsonTileLayer = new L.TileLayer.GeoJSON(geojsonURL, {
            clipTiles: true,
            unique: function (feature) { 
                return feature.id;
            }
        }, {
            style: style,
            onEachFeature: function (feature, layer) {
                if (feature.properties) {
                    var popupString = '<div class="popup">';
                    for (var k in feature.properties) {
                        var v = feature.properties[k];
                        popupString += k + ': ' + v + '<br />';
                    }
                    popupString += '</div>';
                    layer.bindPopup(popupString);
                }
                if (!(layer instanceof L.Point)) {
                    layer.on('mouseover', function () {
                        layer.setStyle(hoverStyle);
                    });
                    layer.on('mouseout', function () {
                        layer.setStyle(style);
                    });
                }
            }
        }
    );
    map.addLayer(geojsonTileLayer);


{% endcomment %}

        
      
      var dataurl = '{% url "data" %}';

      window.addEventListener("map:init", function (event) {
        var map = event.detail.map; 


        // Download GeoJSON data with Ajax
        fetch(dataurl)
          .then(function(resp) {
            return resp.json();
          })
          .then(function(data) {
            L.geoJson(data, {               
              onEachFeature: function onEachFeature(feature, layer) {
                var props = feature.properties;                
                var content = `<h3>${feature.id}</h3><h3>${props.name}</h3><p>${props.description}</p>`;
                layer.bindPopup(content);
            }}).addTo(map);
          });
      });


    </script>
<meta charset="utf-8">
{% endblock extrahead %}

{% block content %}   
<div class="row">
  <div class="col">
    <form method="post">
       {% csrf_token %}
       {{ form|crispy }}
       <button type="submit" class="btn btn-dark btn-block">Отправить</button>
    </form>
  </div>
</div>
{% endblock %}
